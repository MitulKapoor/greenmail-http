<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.6/handlebars.js"></script>
<script src="handlebars_dynamic_loader.js"></script>
<script>

const ANCH = {
	EMAIL: '<a href="/email/%1">%1</a>',
	DOMAIN: '<a href="/domain/%1">%1</a>',
	LIST_MAILBOXES: '<a href="javascript:list_mailboxes(\'%1\')">%2</a>',
	LIST_MESSAGES: '<a href="javascript:list_messages(\'%1\')">%2</a>',
	MAILBOX: '<a href="/mailbox/%1">%1</a>',
	VIEW_MESSAGE: '<a href="javascript:view_message(\'%1\',\'%2\')">%3</a>',
	DELETE_MESSAGE: '<a href="javascript:delete_message(\'%1\',\'%2\')">%3</a>'
};

const URLS = {
	ALL_IMAP: '/imap',
	LIST_MAILBOXES: '/imap/:email',
	LIST_MESSAGES: '/m/:mailbox',
	LIST_USERS: '/lu',
	CONFIG: '/cfg',
	PURGE: '/p',
	RESET: '/r',
	VIEW_MESSAGE: '/v/:mailbox/:uid',
	DELETE_MESSAGE: '/d/:mailbox/:uid'
};

function mk_url(template, params) {
	let s = template;

	for (let i = 0; i < params.length; ++i) {
		let re = new RegExp('%' + (i + 1), 'g');
		s = s.replace(re, params[i]);
	}
	return s;
}

$(document).ready(function () {

	$('#listusers').click(function () {
		$.get(URLS.LIST_USERS, function (data, status) {

			for (let i = 0; i < data.length; ++i) {
				data[i].action_delete = new Handlebars.SafeString('D');
				data[i].action_mailbox = new Handlebars.SafeString(mk_url(ANCH.LIST_MAILBOXES, [data[i].email, 'LF']));
			}

			display_template('#answer', 'list_users', data);

		});
	});

	$('#list_messages').click(function () {
		$.get(URLS.ALL_IMAP, function (data, status) {
			for (let i = 0; i < data.length; ++i) {
				let mailbox = encodeURIComponent(data[i].mailbox);
				let uid = encodeURIComponent(data[i].uid);
				let anc_delete = mk_url(ANCH.DELETE_MESSAGE, [mailbox, uid, 'D']);
				let anc_view = mk_url(ANCH.VIEW_MESSAGE, [mailbox, uid, 'V']);
				data[i].action_delete = new Handlebars.SafeString(anc_delete);
				data[i].action_view = new Handlebars.SafeString(anc_view);
			}

			display_template('#answer', 'list_messages', data);
		});
	});

	$('#purge_all').click(function () {
		$.get(URLS.PURGE, function (data, status) {
			$('#answer').html('Purged');
		});
	});

	$('#reset_all').click(function () {
		$.get(URLS.RESET, function (data, status) {
			$('#answer').html('Reset');
		});
	});

	$('#config').click(function () {
		$.get(URLS.CONFIG, function (data, status) {
			display_template('#answer', 'config', data);
		});
	});

});

function list_mailboxes(email) {
	let url = URLS.LIST_MAILBOXES.replace(':email', email);
	$.get(url, function (data, status) {
		for (let i = 0; i < data.length; ++i) {
			data[i].action_delete = new Handlebars.SafeString('D');
			data[i].action_list_messages = new Handlebars.SafeString(mk_url(ANCH.LIST_MESSAGES, [data[i].fullName, 'LM']));
		}

		display_template('#answer', 'list_mailboxes', data);
	});
}

function list_messages(mailbox) {

	let url = URLS.LIST_MESSAGES.replace(':mailbox', encodeURIComponent(mailbox));
	$.get(url, function (data, status) {

		for (let i = 0; i < data.length; ++i) {
			let mailbox = data[i].mailbox;
			let uid = data[i].uid;
			let anc_delete = mk_url(ANCH.DELETE_MESSAGE, [mailbox, uid, 'D']);
			let anc_view = mk_url(ANCH.VIEW_MESSAGE, [mailbox, uid, 'V']);

			data[i].action_delete = new Handlebars.SafeString(anc_delete);
			data[i].action_view = new Handlebars.SafeString(anc_view);
		}

		display_template('#answer', 'list_messages', data);
	});
}

function view_message(mailbox, uid) {
	let encMailbox = mailbox = encodeURIComponent(mailbox);
	let url = URLS.VIEW_MESSAGE.replace(':mailbox', encMailbox).replace(':uid', uid);
	$.get(url, function (data, status) {
		display_template('#answer', 'view_message', data);
	});
}


</script>
</head>
<body>

<button id="config">Config</button>
<button id="listusers">List users</button>
<button id="list_messages">All messages</button>
<button id="purge_all">Remove all email</button>
<button id="reset_all">Remove all users and emails</button>

<div id="answer">
</div>

</body>
</html>
