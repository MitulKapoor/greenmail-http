<!DOCTYPE html>
<html lang="en-GB">
<head>
<meta charset="utf-8">
<link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous"><script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.6/handlebars.js"></script>
<script src="handlebars_dynamic_loader.js"></script>
<script>

const ANCH = {
	    EMAIL: '<a href="/email/%1">%1</a>',
	    DOMAIN: '<a href="/domain/%1">%1</a>',
//	    LIST_MAILBOXES: '<a href="/imap/%1">%2</a>',
	    LIST_MAILBOXES: '<a href="javascript:list_mailboxes(\'%1\')">%2</a>',
	    MAILBOX: '<a href="/mailbox/%1">%1</a>',
	    MESSAGE_BODY: '<a href="/messbody/%1">%2</a>'
	};

const URLS = {
    ALL_IMAP: '/imap',
    LIST_MAILBOXES: '/imap/:email',
    LIST_USERS: '/lu',
    CONFIG: '/cfg',
    PURGE: '/p',
    RESET: '/r'
};


function mk_url(template, params) {
    let s = template;
    
    for (let i = 0; i < params.length; ++i) {
    	let re = new RegExp('%' + (i + 1), 'g');
        s = s.replace(re, params[i]);
    }
    return s;
}

	
$(document).ready(function () {

/*
function print_mailbox(s) {
    let x = mk_url(ANCH.MAILBOX, [s]);
    return x;
}

function print_messageid(s) {
    let part = s.substring(1, s.length - 1);
    let x = mk_url(ANCH.MESSAGE_BODY, [part, s]);
    return x;
}
*/

$('#listusers').click(function () {
    $.get(URLS.LIST_USERS, function (data, status) {

	for (let i=0 ; i < data.length ; ++i) {
		data[i].action_delete = new Handlebars.SafeString( '<a href="">D</a>');
		data[i].action_mailbox = new Handlebars.SafeString( mk_url(ANCH.LIST_MAILBOXES, [data[i].email, 'LF']) );
//		data[i].action_mailbox = new Handlebars.SafeString( mk_url(ANCH.LIST_MAILBOXES, [data[i].email, 'LF']) );
	}
	
    display_template('#answer', 'list_users', data);

// s += '<td>' + print_mailbox(d.qualifiedMailboxName) +' </td>';
// s += '<td>' + mk_url(ANCH.LIST_MAILBOXES, [d.email, 'List folders']) +' </td>';

    });
});

$('#imap_all_messages').click(function () {
    $.get(URLS.ALL_IMAP, function (data, status) {
    	display_template('#answer', 'imap_all_messages', data);
    });
});

$('#purge_all').click(function () {
    $.get(URLS.PURGE, function (data, status) {
        $('#answer').html('Purged');
    });
});

$('#reset_all').click(function () {
    $.get(URLS.RESET, function (data, status) {
        $('#answer').html('Reset');
    });
});

/*
function list_mailboxes(email) {
    $.get(URLS.LIST_MAILBOXES + '/' + email, function (data, status) {
    	display_template('#answer', 'list_mailboxes', data);
    });
}
*/

/*
$('#list_mailboxes').click(function () {
    $.get(URLS.LIST_MAILBOXES + '/blar@blar.com', function (data, status) {
    	display_template('#answer', 'list_mailboxes', data);
    });
});
*/

$('#config').click(function () {
    $.get(URLS.CONFIG, function (data, status) {
        display_template('#answer', 'config', data);
    });
});

});

function list_mailboxes(email) {
	let url = URLS.LIST_MAILBOXES.replace(':email', email);
    $.get(url, function (data, status) {
    	display_template('#answer', 'list_mailboxes', data);
    });
}

</script>
</head>
<body>

<button id="config">Config</button>
<button id="listusers">List users</button>
<button id="imap_all_messages">IMAP all messages</button>
<button id="purge_all">Remove all email</button>
<button id="reset_all">Remove all users and emails</button>

<div id="answer">
</div>

</body>
</html>
